name: 🚀 Prima+ E2E Test Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cypress-run:
    name: 🧪 Cypress E2E Tests
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
      fail-fast: false # Continue testing other browsers even if one fails
      
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 🔧 Install Dependencies
        run: npm ci
        
      - name: 🏥 Health Check - API Endpoint
        run: |
          curl -f https://gateway-api.prod.iprima.cz/json-rpc/ || echo "API endpoint check failed"
          
      - name: 🧪 Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          wait-on: 'https://www.iprima.cz'
          wait-on-timeout: 60
          config: video=true,screenshotOnRunFailure=true
          spec: cypress/e2e/**/*.cy.ts
        env:
          CYPRESS_TEST_EMAIL: ${{ secrets.PRIMA_TEST_EMAIL }}
          CYPRESS_TEST_PASSWORD: ${{ secrets.PRIMA_TEST_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 📊 Generate Test Report
        if: always()
        run: |
          npx mochawesome-merge cypress/reports/*.json > cypress/reports/merged-report.json
          npx mochawesome-report-generator cypress/reports/merged-report.json --reportDir cypress/reports --inline
        continue-on-error: true
        
      - name: 📁 Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-results-${{ matrix.browser }}
          path: |
            cypress/reports/
            cypress/report/videos/
            cypress/report/screenshots/
          retention-days: 30
          
      - name: 📝 Comment Test Results on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            try {
              const reportPath = 'cypress/reports/merged-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath));
                const stats = report.stats;
                const status = stats.failures === 0 ? '✅' : '❌';
                const body = `
                ## ${status} E2E Test Results - ${{ matrix.browser }}
                
                - **Tests Run**: ${stats.tests}
                - **Passed**: ${stats.passes} ✅
                - **Failed**: ${stats.failures} ❌  
                - **Duration**: ${stats.duration}ms
                - **Browser**: ${{ matrix.browser }}
                
                ${stats.failures > 0 ? '⚠️ Some tests failed. Check the artifacts for details.' : '🎉 All tests passed!'}
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
            } catch (error) {
              console.log('Could not parse test results:', error);
            }

  security-scan:
    name: 🔒 Security Scan
    runs-on: ubuntu-22.04
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 🔍 Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
        
      - name: 🛡️ Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: typescript

  dependency-check:
    name: 📋 Dependency Check
    runs-on: ubuntu-22.04
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📊 Check for outdated packages
        run: npm outdated || true
        
      - name: 🔄 Check for package vulnerabilities
        run: npm audit --json > audit-results.json || true
        
      - name: 📁 Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-results.json
          retention-days: 7